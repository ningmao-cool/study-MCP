<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCPå­¦ä¹ é¡¹ç›® - æµç¨‹ç¼–æ’æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.running {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.completed {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.failed {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .tool-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .tool-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tool-item h4 {
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .tool-item p {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ MCPå­¦ä¹ é¡¹ç›®</h1>
            <p>Model Context Protocol ä¸æµç¨‹ç¼–æ’æ¼”ç¤ºå¹³å°</p>
        </div>
        
        <div class="content">
            <!-- MCPå·¥å…·ç®¡ç† -->
            <div class="section">
                <h2>ğŸ”§ MCPå·¥å…·ç®¡ç†</h2>
                <div class="grid">
                    <div class="card">
                        <h3>å¯ç”¨å·¥å…·</h3>
                        <p>æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰å¯ç”¨çš„MCPå·¥å…·</p>
                        <button class="btn" onclick="loadTools()">åŠ è½½å·¥å…·åˆ—è¡¨</button>
                        <div id="toolsList" class="tool-list"></div>
                    </div>
                    
                    <div class="card">
                        <h3>å·¥å…·æ‰§è¡Œ</h3>
                        <p>æµ‹è¯•å·¥å…·æ‰§è¡ŒåŠŸèƒ½</p>
                        <div style="margin:10px 0;">
                            <strong>æ–‡ä»¶å·¥å…·å‚æ•°</strong>
                            <div style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px;">
                                <input id="filePathInput" type="text" placeholder="æ–‡ä»¶è·¯å¾„ï¼Œä¾‹å¦‚: test.txt" style="padding:10px;border:1px solid #ddd;border-radius:6px;">
                                <textarea id="fileContentInput" rows="3" placeholder="æ–‡ä»¶å†…å®¹" style="padding:10px;border:1px solid #ddd;border-radius:6px;"></textarea>
                            </div>
                        </div>
                        <button class="btn" onclick="testFileTool()">æµ‹è¯•æ–‡ä»¶å·¥å…·</button>
                        <hr style="margin:16px 0; border:none; border-top:1px solid #eee;">
                        <div style="margin:10px 0;">
                            <strong>æœç´¢å·¥å…·å‚æ•°</strong>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
                                <input id="searchQueryInput" type="text" placeholder="æŸ¥è¯¢å…³é”®è¯ï¼Œä¾‹å¦‚: class" style="padding:10px;border:1px solid #ddd;border-radius:6px;grid-column: span 2;">
                                <input id="searchFileTypeInput" type="text" placeholder="æ–‡ä»¶ç±»å‹(å¯é€‰)ï¼Œä¾‹å¦‚: java" style="padding:10px;border:1px solid #ddd;border-radius:6px;">
                                <input id="searchIncludeDirsInput" type="text" placeholder="includeDirs(é€—å·åˆ†éš”)ï¼Œé»˜è®¤ src/main/java" style="padding:10px;border:1px solid #ddd;border-radius:6px;">
                                <input id="searchExcludeDirsInput" type="text" placeholder="excludeDirs(é€—å·åˆ†éš”)ï¼Œä¾‹å¦‚: target,.git" style="padding:10px;border:1px solid #ddd;border-radius:6px;">
                            </div>
                        </div>
                        <button class="btn" onclick="testSearchTool()">æµ‹è¯•æœç´¢å·¥å…·</button>
                        <div id="toolResult" class="log"></div>
                    </div>
                </div>
            </div>
            
            <!-- å·¥ä½œæµç®¡ç† -->
            <div class="section">
                <h2>âš¡ å·¥ä½œæµç®¡ç†</h2>
                <div class="grid">
                    <div class="card">
                        <h3>å·¥ä½œæµåˆ—è¡¨</h3>
                        <p>æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„å·¥ä½œæµ</p>
                        <button class="btn" onclick="loadWorkflows()">åŠ è½½å·¥ä½œæµ</button>
                        <div id="workflowsList"></div>
                    </div>
                    
                    <div class="card">
                        <h3>å·¥ä½œæµæ‰§è¡Œ</h3>
                        <p>æ‰§è¡Œé€‰å®šçš„å·¥ä½œæµ</p>
                        <select id="workflowSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">é€‰æ‹©å·¥ä½œæµ...</option>
                        </select>
                        <button class="btn btn-success" onclick="executeWorkflow()">æ‰§è¡Œå·¥ä½œæµ</button>
                        <button class="btn btn-secondary" onclick="loadRunningExecutions()">æŸ¥çœ‹è¿è¡Œä¸­</button>
                    </div>
                </div>
            </div>
            
            <!-- æ‰§è¡Œç›‘æ§ -->
            <div class="section">
                <h2>ğŸ“Š æ‰§è¡Œç›‘æ§</h2>
                <div class="grid">
                    <div class="card">
                        <h3>æ‰§è¡ŒçŠ¶æ€</h3>
                        <p>ç›‘æ§å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€</p>
                        <div id="executionStatus"></div>
                        <div id="executionProgress" class="progress" style="display: none;">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                        <div id="executionLog" class="log"></div>
                    </div>
                    
                    <div class="card">
                        <h3>ç³»ç»ŸçŠ¶æ€</h3>
                        <p>æŸ¥çœ‹ç³»ç»Ÿæ•´ä½“çŠ¶æ€</p>
                        <button class="btn" onclick="loadSystemStatus()">åˆ·æ–°çŠ¶æ€</button>
                        <div id="systemStatus"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentExecutionId = null;
        let statusCheckInterval = null;
        
        // åŠ è½½å·¥å…·åˆ—è¡¨
        async function loadTools() {
            try {
                const response = await fetch(`${API_BASE}/mcp/tools`);
                const tools = await response.json();
                
                const toolsList = document.getElementById('toolsList');
                toolsList.innerHTML = tools.map(tool => `
                    <div class="tool-item">
                        <h4>${tool.name}</h4>
                        <p>${tool.description}</p>
                        <small>åˆ†ç±»: ${tool.category}</small>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å·¥å…·å¤±è´¥:', error);
            }
        }
        
        // æµ‹è¯•æ–‡ä»¶å·¥å…·
        async function testFileTool() {
            try {
                const result = document.getElementById('toolResult');
                result.innerHTML = 'æ‰§è¡Œä¸­...\n';
                const filePath = (document.getElementById('filePathInput').value || 'test.txt').trim();
                const fileContent = (document.getElementById('fileContentInput').value || 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œç”±MCPå·¥å…·åˆ›å»ºï¼');
                
                const response = await fetch(`${API_BASE}/mcp/tools/create_file/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: filePath, content: fileContent })
                });
                
                const data = await response.json();
                result.innerHTML += `æ‰§è¡Œç»“æœ: ${JSON.stringify(data, null, 2)}\n`;
            } catch (error) {
                console.error('æµ‹è¯•æ–‡ä»¶å·¥å…·å¤±è´¥:', error);
            }
        }
        
        // æµ‹è¯•æœç´¢å·¥å…·
        async function testSearchTool() {
            try {
                const result = document.getElementById('toolResult');
                result.innerHTML = 'æœç´¢ä¸­...\n';
                const query = (document.getElementById('searchQueryInput').value || 'class').trim();
                const fileType = (document.getElementById('searchFileTypeInput').value || '').trim();
                const includeDirsRaw = (document.getElementById('searchIncludeDirsInput').value || 'src/main/java').trim();
                const excludeDirsRaw = (document.getElementById('searchExcludeDirsInput').value || '').trim();
                const includeDirs = includeDirsRaw.split(',').map(s => s.trim()).filter(Boolean);
                const excludeDirs = excludeDirsRaw.split(',').map(s => s.trim()).filter(Boolean);
                const payload = { query, includeDirs };
                if (fileType) payload.fileType = fileType;
                if (excludeDirs.length > 0) payload.excludeDirs = excludeDirs;
                
                const response = await fetch(`${API_BASE}/mcp/tools/search_codebase/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                result.innerHTML += `æœç´¢ç»“æœ: ${JSON.stringify(data, null, 2)}\n`;
            } catch (error) {
                console.error('æµ‹è¯•æœç´¢å·¥å…·å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å·¥ä½œæµåˆ—è¡¨
        async function loadWorkflows() {
            try {
                const response = await fetch(`${API_BASE}/workflows`);
                const workflows = await response.json();
                
                const workflowsList = document.getElementById('workflowsList');
                const workflowSelect = document.getElementById('workflowSelect');
                
                workflowsList.innerHTML = workflows.map(workflow => `
                    <div class="card">
                        <h3>${workflow.name}</h3>
                        <p>${workflow.description}</p>
                        <p><strong>çŠ¶æ€:</strong> ${workflow.status}</p>
                        <p><strong>æ­¥éª¤æ•°:</strong> ${workflow.steps ? workflow.steps.length : 0}</p>
                    </div>
                `).join('');
                
                // æ›´æ–°é€‰æ‹©æ¡†
                workflowSelect.innerHTML = '<option value="">é€‰æ‹©å·¥ä½œæµ...</option>' +
                    workflows.map(workflow => `<option value="${workflow.id}">${workflow.name}</option>`).join('');
            } catch (error) {
                console.error('åŠ è½½å·¥ä½œæµå¤±è´¥:', error);
            }
        }
        
        // æ‰§è¡Œå·¥ä½œæµ
        async function executeWorkflow() {
            const workflowId = document.getElementById('workflowSelect').value;
            if (!workflowId) {
                alert('è¯·é€‰æ‹©å·¥ä½œæµ');
                return;
            }
            
            try {
                // é‡ç½®ç›‘æ§åŒºåŸŸ
                if (statusCheckInterval) { clearInterval(statusCheckInterval); statusCheckInterval = null; }
                document.getElementById('executionLog').innerHTML = '';
                const progress = document.getElementById('executionProgress');
                const progressBar = progress.querySelector('.progress-bar');
                progressBar.style.width = '0%';
                progress.style.display = 'none';

                const response = await fetch(`${API_BASE}/workflows/${workflowId}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parameters: {},
                        executedBy: 'web-user'
                    })
                });
                
                const execution = await response.json();
                currentExecutionId = execution.executionId;
                
                document.getElementById('executionStatus').innerHTML = `
                    <div class="status running">
                        æ‰§è¡Œå·²å¯åŠ¨: ${execution.executionId}
                    </div>
                `;
                
                // å¼€å§‹ç›‘æ§æ‰§è¡ŒçŠ¶æ€
                startStatusMonitoring(execution.executionId);
            } catch (error) {
                console.error('æ‰§è¡Œå·¥ä½œæµå¤±è´¥:', error);
            }
        }
        
        // åŠ è½½è¿è¡Œä¸­çš„æ‰§è¡Œ
        async function loadRunningExecutions() {
            try {
                const response = await fetch(`${API_BASE}/workflows/executions/running`);
                const executions = await response.json();
                
                const status = document.getElementById('executionStatus');
                if (executions.length === 0) {
                    status.innerHTML = '<div class="status">æ²¡æœ‰è¿è¡Œä¸­çš„æ‰§è¡Œ</div>';
                } else {
                    status.innerHTML = executions.map(execution => `
                        <div class="status running">
                            æ‰§è¡ŒID: ${execution.executionId}<br>
                            è¿›åº¦: ${execution.completedSteps}/${execution.totalSteps}<br>
                            çŠ¶æ€: ${execution.status}
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½è¿è¡Œä¸­æ‰§è¡Œå¤±è´¥:', error);
            }
        }
        
        // å¼€å§‹çŠ¶æ€ç›‘æ§
        function startStatusMonitoring(executionId) {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            statusCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/workflows/executions/${executionId}`);
                    if (!response.ok) {
                        // 404ï¼šæ‰§è¡Œä¸å­˜åœ¨ï¼ˆå¯èƒ½å› åº”ç”¨é‡å¯æˆ–å†…å­˜åº“é‡ç½®ï¼‰
                        if (response.status === 404) {
                            clearInterval(statusCheckInterval);
                            statusCheckInterval = null;
                            document.getElementById('executionStatus').innerHTML = '<div class="status">æ‰§è¡Œä¸å­˜åœ¨ï¼ˆå¯èƒ½å·²é‡å¯ï¼‰ï¼Œè¯·é‡æ–°æ‰§è¡Œå·¥ä½œæµ</div>';
                            return;
                        }
                        // å…¶å®ƒé”™è¯¯ï¼šçŸ­æš‚æç¤ºå¹¶ç»§ç»­ä¸‹ä¸€è½®
                        console.warn('çŠ¶æ€è·å–å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
                        return;
                    }
                    const execution = await response.json();
                    
                    const status = document.getElementById('executionStatus');
                    const progress = document.getElementById('executionProgress');
                    const progressBar = progress.querySelector('.progress-bar');
                    const log = document.getElementById('executionLog');
                    
                    // æ›´æ–°çŠ¶æ€
                    let statusClass = 'running';
                    if (execution.status === 'COMPLETED') statusClass = 'completed';
                    else if (execution.status === 'FAILED') statusClass = 'failed';
                    
                    status.innerHTML = `
                        <div class="status ${statusClass}">
                            æ‰§è¡ŒID: ${execution.executionId}<br>
                            çŠ¶æ€: ${execution.status}<br>
                            è¿›åº¦: ${execution.completedSteps}/${execution.totalSteps}
                        </div>
                    `;
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    if (execution.totalSteps > 0) {
                        const progressPercent = (execution.completedSteps / execution.totalSteps) * 100;
                        progressBar.style.width = `${progressPercent}%`;
                        progress.style.display = 'block';
                    }
                    
                    // æ›´æ–°æ—¥å¿—
                    log.innerHTML += `${new Date().toLocaleTimeString()}: çŠ¶æ€æ›´æ–° - ${execution.status}\n`;
                    log.scrollTop = log.scrollHeight;
                    
                    // å¦‚æœæ‰§è¡Œå®Œæˆï¼Œåœæ­¢ç›‘æ§
                    if (execution.status === 'COMPLETED' || execution.status === 'FAILED') {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = null;
                    }
                } catch (error) {
                    console.error('ç›‘æ§æ‰§è¡ŒçŠ¶æ€å¤±è´¥:', error);
                }
            }, 2000);
        }
        
        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        async function loadSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/mcp/status`);
                const status = await response.json();
                
                document.getElementById('systemStatus').innerHTML = `
                    <div class="card">
                        <h3>ç³»ç»Ÿä¿¡æ¯</h3>
                        <p><strong>å·¥å…·æ•°é‡:</strong> ${status.toolCount}</p>
                        <p><strong>å¯ç”¨å·¥å…·:</strong> ${status.availableTools.join(', ')}</p>
                        <p><strong>æ—¶é—´æˆ³:</strong> ${new Date(status.timestamp).toLocaleString()}</p>
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadTools();
            loadWorkflows();
            loadSystemStatus();
        };
    </script>
</body>
</html> 